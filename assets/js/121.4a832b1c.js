(window.webpackJsonp=window.webpackJsonp||[]).push([[121],{497:function(e,a,r){"use strict";r.r(a);var l=r(13),d=Object(l.a)({},(function(){var e=this,a=e.$createElement,r=e._self._c||a;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("p",[e._v("原文地址：\nhttps://juejin.im/post/5caf0a7cf265da03a33c24d4")]),e._v(" "),r("h3",{attrs:{id:"请你详细谈谈什么是zab协议"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#请你详细谈谈什么是zab协议"}},[e._v("#")]),e._v(" 请你详细谈谈什么是zab协议？")]),e._v(" "),r("p",[e._v("zab协议是zookeeper专门设计的支持崩溃恢复的原子广播协议。目的是实现分布式zoopkeeper各个节点数据一致性。Zab 主要靠 2 个模式来保证一致性，分别是恢复模式（选 leader）和广播模式 。")]),e._v(" "),r("p",[e._v("恢复模式：在集群启动之初，或是 leader 挂掉之后，各个服务器开始选出新 leader，并更新年号纪元（要点是选 zxid 最大的服务器）。恢复过程中，为了保证一致性需要解决两个问题，一个是旧leader已经commit的提议必须应用到所有follower，另一个是仅有旧leader 提出的提议必须回滚，解决上述俩问题的要点也是选 zxid 最大的服务器作为新 leader。")]),e._v(" "),r("p",[e._v("广播模式：leader 在应用事务请求之前，必须取得超半数 follower 的同意，过程及其类似两阶段提交。和两阶段不同的是，leader 发出提议后，follower 需记录在事务日志中，写磁盘成功后返回 ack，leader 得到超半数 ack 后，统一 commit（因为 follower 有队列实现事务串行且有事务日志，所以 commit 大概率成功）；另外，Zab 没有 rollback 选项，若 follower 不同意 leader 的提议，该 follower 被踢出投票席（所以只能 ack），需重新同步 leader 数据。")]),e._v(" "),r("p",[e._v('zab协议约定zk节点有两种角色leader和follower,zk客户端会随机的链接到zookeeper集群中的一个节点，如果是读请求，就直接从当前节点中读取数据；如果是写请求，那么节点就会向 Leader 提交事务，Leader 接收到事务提交，会广播该事务，只要超过半数节点写入成功，该事务就会被提交。另外，Zookeeper是一个树形结构，具有顺序性很多操作都要先检查才能确定是否可以执行，比如P1的事务t1可能是创建节点"/a"，t2可能是创建节点"/a/b"，只有先创建了父节点"/a"，才能创建子节点"/a/b"。为了实现这一点，Zab协议要保证同一个Leader发起的事务要按顺序被执行，同时还要保证只有先前Leader的事务被执行之后，新选举出来的Leader才能再次发起事务')]),e._v(" "),r("h3",{attrs:{id:"那选举新leader的算法是什么"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#那选举新leader的算法是什么"}},[e._v("#")]),e._v(" 那选举新leader的算法是什么？")]),e._v(" "),r("p",[e._v("那我举个例子来说明吧，假如当前有zk1,zk2,zk3,三个节点组成一个集群，现在zk3节点挂了。\n1、首先zk1和zk2都会将自己作为Leader服务器来进行投票，每次投票会包含所推举的服务器的myid和ZXID，使用(myid, ZXID)来表示，假设此时ZK1的投票为(1, 1)，ZK2的投票为(2, 1)，然后各自将这个投票发给集群中其他机器\n2、各服务器接收到投票之后会进行进行检查，如检查是否是本轮投票、是否来自LOOKING状态的服务器\n3、开始处理投票，服务器都需要将别人的投票和自己的myid和zxid进行比较，规则是优先检查ZXID。ZXID比较大的服务器优先作为Leader。如果ZXID相同，那么就比较myid。myid较大的服务器作为Leader服务器，在例子很明显zk2,会成为新的leader。")]),e._v(" "),r("h3",{attrs:{id:"那重新投票选举leader怎么保证数据不会丢失"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#那重新投票选举leader怎么保证数据不会丢失"}},[e._v("#")]),e._v(" 那重新投票选举leader怎么保证数据不会丢失？")]),e._v(" "),r("p",[e._v("我们都知道，zk是cp的，不一定保证可用性，在选举的过程中，不能对外提供服务。但在选举的过程中，首先选zxid（zk的事务ID）最大的为leader,zxid最大，表示数据是最新的，然后广播给folower，这样避免数据丢失。")])])}),[],!1,null,null,null);a.default=d.exports}}]);